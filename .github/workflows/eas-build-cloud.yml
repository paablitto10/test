name: 'EAS Build (Cloud) & Submit'

on:
  workflow_dispatch:
    inputs:
      auto_submit:
        description: 'Submit to stores after build'
        type: boolean
        default: false
      platform:
        description: 'Platform to build for'
        type: choice
        options: [ios, android]
        default: ios
      profile:
        description: 'EAS build profile'
        type: choice
        options: [preview, production]
        default: production

run-name: 'EAS cloud build for ${{ github.event.inputs.platform }} (${{ github.event.inputs.profile }})'

jobs:
  eas-build:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.profile }}

    steps:
      - name: 'ğŸ— Setup repo'
        uses: actions/checkout@v4

      - name: 'ğŸ— Setup Node'
        uses: ./.github/actions/setup-node-environment
        with:
          node-version: '20'
          cache-path: 'node_modules'
          cache-key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: 'ğŸ“¦ Install dependencies'
        run: npm ci

      - name: 'ğŸ— Setup EAS'
        uses: ./.github/actions/setup-expo
        with:
          expo-token: ${{ secrets.EXPO_TOKEN }}

      - name: 'ğŸ”§ Force remote credentials for cloud build'
        run: |
          node .github/force-remote-credentials.js \
            --profile "${{ github.event.inputs.profile }}" \
            --platform "${{ github.event.inputs.platform }}"

      - name: 'ğŸ‘· EAS Cloud build'
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build \
            --non-interactive \
            --platform=${{ github.event.inputs.platform }} \
            --profile=${{ github.event.inputs.profile }}

      - name: 'ğŸš€ Submit to stores (optional)'
        if: ${{ github.event.inputs.auto_submit == 'true' }}
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas submit \
            --non-interactive \
            --platform=${{ github.event.inputs.platform }} \
            --profile=${{ github.event.inputs.profile }}
